<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Notebook Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 font-serif text-gray-800">Perfect Notebook Converter</h1>
        
        <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
            <!-- UI controls remain the same -->
            <div class="flex gap-4 mb-4 flex-wrap">
                <div>
                    <label class="block text-sm font-bold mb-2">Pen Color:</label>
                    <div class="flex gap-2">
                        <button data-color="text-black" class="pen-color w-8 h-8 rounded-full bg-black border-2 border-gray-300 ring-2 ring-blue-500"></button>
                        <button data-color="text-blue-600" class="pen-color w-8 h-8 rounded-full bg-blue-600 border-2 border-gray-300"></button>
                        <button data-color="text-red-600" class="pen-color w-8 h-8 rounded-full bg-red-600 border-2 border-gray-300"></button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Background:</label>
                    <div class="flex gap-2">
                        <button data-bg="bg-white" class="bg-color w-8 h-8 rounded-full bg-white border-2 border-gray-300 ring-2 ring-blue-500"></button>
                        <button data-bg="bg-amber-50" class="bg-color w-8 h-8 rounded-full bg-amber-50 border-2 border-gray-300"></button>
                    </div>
                </div>
            </div>

            <!-- Text input and preview sections remain the same -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2 font-sans">
                    Type your notes:
                </label>
                <textarea 
                    id="textInput" 
                    class="w-full h-48 p-4 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 bg-gray-50 font-sans placeholder-gray-400"
                    placeholder="Write your notes here..."></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2 font-sans">
                    Notebook Preview:
                </label>
                <div 
                    id="preview" 
                    class="w-full min-h-[300px] p-6 rounded-lg font-['Caveat'] text-2xl border-l-4 border-red-200 
                           bg-[length:100%_40px] bg-[linear-gradient(to_bottom,#cbd5e1_1px,transparent_1px)] 
                           leading-[40px] pl-[52px] shadow-inner pt-2 bg-white text-black"
                    style="white-space: pre-wrap; word-wrap: break-word;"></div>
            </div>
            
            <div class="flex justify-end gap-4">
                <button 
                    id="resetBtn"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg 
                           transition-all duration-200 shadow-md hover:shadow-lg">
                    Reset
                </button>
                <button 
                    id="downloadBtn"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg 
                           transition-all duration-200 shadow-md hover:shadow-lg">
                    ðŸ“¥ Download Perfect Copy
                </button>
            </div>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('textInput');
        const preview = document.getElementById('preview');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const penColors = document.querySelectorAll('.pen-color');
        const bgColors = document.querySelectorAll('.bg-color');

        let currentColor = 'text-black';
        let currentBg = 'bg-white';

        // Initialize
        textInput.addEventListener('input', updatePreview);
        penColors.forEach(btn => btn.addEventListener('click', changePenColor));
        bgColors.forEach(btn => btn.addEventListener('click', changeBgColor));
        resetBtn.addEventListener('click', resetDefaults);
        downloadBtn.addEventListener('click', () => downloadPerfectCopy().catch(console.error));

        // Set initial state
        document.querySelector('.pen-color[data-color="text-black"]').classList.add('ring-2', 'ring-blue-500');
        document.querySelector('.bg-color[data-bg="bg-white"]').classList.add('ring-2', 'ring-blue-500');
        updatePreview();

        function updatePreview() {
            preview.textContent = textInput.value;
            void preview.offsetHeight; // Trigger reflow
        }

        function changePenColor(e) {
            const color = e.target.dataset.color;
            preview.classList.replace(currentColor, color);
            currentColor = color;
            penColors.forEach(b => b.classList.remove('ring-2', 'ring-blue-500'));
            e.target.classList.add('ring-2', 'ring-blue-500');
        }

        function changeBgColor(e) {
            const bg = e.target.dataset.bg;
            preview.classList.replace(currentBg, bg);
            currentBg = bg;
            bgColors.forEach(b => b.classList.remove('ring-2', 'ring-blue-500'));
            e.target.classList.add('ring-2', 'ring-blue-500');
        }

        function resetDefaults() {
            // Fixed: Only remove current color classes instead of all text/bg classes
            preview.classList.remove(currentColor);
            preview.classList.remove(currentBg);
            preview.classList.add('bg-white', 'text-black');
            currentColor = 'text-black';
            currentBg = 'bg-white';
            textInput.value = '';
            penColors.forEach(b => b.classList.remove('ring-2', 'ring-blue-500'));
            bgColors.forEach(b => b.classList.remove('ring-2', 'ring-blue-500'));
            document.querySelector('.pen-color[data-color="text-black"]').classList.add('ring-2', 'ring-blue-500');
            document.querySelector('.bg-color[data-bg="bg-white"]').classList.add('ring-2', 'ring-blue-500');
            updatePreview();
        }

        async function downloadPerfectCopy() {
            try {
                // Ensure font is loaded before proceeding
                await document.fonts.load('32px "Caveat"');
            } catch (e) {
                console.error('Font loading error:', e);
                alert('Error loading font. Please try again.');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scale = 3;
            
            // Get precise measurements
            const previewRect = preview.getBoundingClientRect();
            const style = window.getComputedStyle(preview);
            const lineHeight = parseFloat(style.lineHeight);
            const paddingTop = parseFloat(style.paddingTop);
            const paddingLeft = parseFloat(style.paddingLeft);
            const paddingRight = parseFloat(style.paddingRight);
            const maxTextWidth = previewRect.width - paddingLeft - paddingRight - 28;

            // Set canvas dimensions
            canvas.width = Math.floor(previewRect.width * scale);
            canvas.height = Math.floor(preview.scrollHeight * scale);
            
            // HD rendering setup
            ctx.scale(scale, scale);
            ctx.imageSmoothingEnabled = false;

            // Draw background
            ctx.fillStyle = style.backgroundColor;
            ctx.fillRect(0, 0, canvas.width/scale, canvas.height/scale);

            // Draw margin line
            ctx.strokeStyle = '#fecaca';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(32.5, 0);
            ctx.lineTo(32.5, canvas.height/scale);
            ctx.stroke();

            // Draw horizontal lines
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 1;
            for(let y = paddingTop; y < canvas.height/scale; y += lineHeight) {
                const lineY = Math.floor(y) + 0.5;
                ctx.beginPath();
                ctx.moveTo(44.5, lineY);
                ctx.lineTo(canvas.width/scale - 20.5, lineY);
                ctx.stroke();
            }

            // Prepare text
            ctx.font = `32px "Caveat"`;
            ctx.fillStyle = style.color;
            ctx.textBaseline = 'top';

            // Wrap text and draw
            const lines = preview.textContent.split('\n');
            let currentY = paddingTop;
            
            lines.forEach(originalLine => {
                const words = originalLine.split(' ');
                let currentLine = words[0] || '';
                
                for(let i = 1; i < words.length; i++) {
                    const testLine = currentLine + ' ' + words[i];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxTextWidth) {
                        ctx.fillText(currentLine, paddingLeft, currentY);
                        currentY += lineHeight;
                        currentLine = words[i];
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    ctx.fillText(currentLine, paddingLeft, currentY);
                    currentY += lineHeight;
                }
            });

            // Create download
            const link = document.createElement('a');
            link.download = 'perfect-copy.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }
    </script>
</body>
</html>
